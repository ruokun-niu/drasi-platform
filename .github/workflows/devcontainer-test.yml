# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


name: Test Drasi Learning Devcontainers
on:
  push:
    branches: devcontainer-workflow
#   pull_request:
#     branches: [main]
  workflow_dispatch: # Allow manual triggering
  schedule:
    - cron: '0 8 * * 1' # Weekly test on Mondays


jobs:
    test-devcontainer:
      runs-on: ubuntu-latest
    # strategy:
    #   matrix:
    #     tutorial:
    #       - name: "Curbside Pickup"
    #         directory: "curbside-pickup"
    #       - name: "Building Comfort"
    #         directory: "building-comfort"
    #       - name: "Fleet POC"
    #         directory: "fleet-poc"
    #       - name: "Non Events"
    #         directory: "non-events"

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            repository: drasi-project/learning
            path: ./learning

        - name: Install Devcontainers CLI
          run:  npm install -g @devcontainers/cli

        - name: Getting Started
          run: |
            devcontainer up --workspace-folder ./learning 


            echo "Applying Drasi Source"
            devcontainer exec --workspace-folder ./learning  drasi apply -f ./resources/hello-world-source.yaml
            devcontainer exec --workspace-folder ./learning  drasi wait source hello-world -t 120
            devcontainer exec --workspace-folder ./learning  drasi list source

            echo "Applying Drasi Queries"
            devcontainer exec --workspace-folder ./learning  drasi apply -f ./resources/hello-world-queries.yaml
            sleep 5
            devcontainer exec --workspace-folder ./learning drasi list query

            echo "Applying Drasi Reaction"
            devcontainer exec --workspace-folder ./learning  drasi apply -f ./resources/hello-world-reaction.yaml
            devcontainer exec --workspace-folder ./learning  drasi wait reaction hello-world-debug -t 120
            devcontainer exec --workspace-folder ./learning  drasi list reaction

            # Test the result somehow

            echo "ðŸŽ‰ Devcontainer test completed successfully!"
        
        - name: Risky Container
          run: |
                echo "Running risky container"
                devcontainer up --workspace-folder ./learning --config ./learning/.devcontainer/risky-container/devcontainer.json 


                echo "Deploying the my-app pods"
                devcontainer exec --workspace-folder ./learning --container-name risky-container kubectl apply -f ./resources/my-app.yaml  
                devcontainer exec --workspace-folder ./learning --container-name risky-container kubectl wait --for=condition=Ready pod -l app=my-app --timeout=120s

                echo "Storing Kubernetes credentials in a secret"
                devcontainer exec --workspace-folder ./learning --container-name risky-container k3d kubeconfig get k3s-default | sed 's/0.0.0.0.*/kubernetes.default.svc/g' | kubectl create secret generic k8s-context --from-file=context=/dev/stdin -n drasi-system

                echo "Applying Drasi Source"
                devcontainer exec --workspace-folder ./learning --container-name risky-container drasi apply -f ./resources/sources.yaml
                devcontainer exec --workspace-folder ./learning --container-name risky-container drasi wait -f ./resources/sources.yaml -t 120


                echo "Applying Drasi Queries"
                devcontainer exec --workspace-folder ./learning --container-name risky-container drasi apply -f ./resources/queries.yaml
                sleep 5
                devcontainer exec --workspace-folder ./learning --container-name risky-container drasi list query

                


