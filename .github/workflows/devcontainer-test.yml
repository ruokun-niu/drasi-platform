# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


name: Test Drasi Learning Devcontainers
on:
  push:
    branches: devcontainer-workflow
#   pull_request:
#     branches: [main]
  workflow_dispatch: # Allow manual triggering
  schedule:
    - cron: '0 8 * * 1' # Weekly test on Mondays


jobs:
    test-devcontainer:
      runs-on: ubuntu-latest
    # strategy:
    #   matrix:
    #     tutorial:
    #       - name: "Curbside Pickup"
    #         directory: "curbside-pickup"
    #       - name: "Building Comfort"
    #         directory: "building-comfort"
    #       - name: "Fleet POC"
    #         directory: "fleet-poc"
    #       - name: "Non Events"
    #         directory: "non-events"

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            repository: drasi-project/learning
            path: ./learning

        - name: Install Devcontainers CLI
          run:  npm install -g @devcontainers/cli

        - name: Test devcontainer build and run
          run: |
            devcontainer up --workspace-folder ./learning 

            echo "Applying Drasi Source"
            devcontainer exec --workspace-folder ./learning  drasi apply -f ./resources/hello-world-source.yaml
            devcontainer exec --workspace-folder ./learning  drasi wait source hello-world -t 120
            devcontainer exec --workspace-folder ./learning  drasi list source

            echo "Applying Drasi Queries"
            devcontainer exec --workspace-folder ./learning  drasi apply -f ./resources/hello-world-queries.yaml
            sleep 5
            devcontainer exec --workspace-folder ./learning drasi list query

            echo "Applying Drasi Reaction"
            devcontainer exec --workspace-folder ./learning  drasi apply -f ./resources/hello-world-reactions.yaml
            devcontainer exec --workspace-folder ./learning  drasi wait reaction hello-world-debug -t 120
            devcontainer exec --workspace-folder ./learning  drasi list reaction

            # Test the result somehow

            
            echo "ðŸŽ‰ Devcontainer test completed successfully!"
